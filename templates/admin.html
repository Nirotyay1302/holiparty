{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">ðŸŽ¯ Admin Panel - Holi Party 2026</h2>

    <!-- Navigation -->
    <div class="mb-4">
        <nav aria-label="Admin navigation">
            <ul class="nav nav-pills">
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('admin') }}">ðŸ“Š Bookings</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('admin_content') }}">ðŸŽ¨ Content Management</a>
                </li>
                <li class="nav-item">
                    <a class="btn btn-outline-danger btn-sm ms-3" href="{{ url_for('admin_login') }}">ðŸšª Logout</a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Statistics Dashboard -->
    <div class="admin-stats mb-4">
        <div class="stat-card">
            <h3>{{ bookings|length }}</h3>
            <p>Total Bookings</p>
        </div>
        <div class="stat-card">
            <h3>{{ bookings|selectattr('payment_status', 'equalto', 'Paid')|list|length }}</h3>
            <p>Paid Bookings</p>
        </div>
        <div class="stat-card">
            <h3>{{ bookings|selectattr('payment_status', 'equalto', 'Pending')|list|length + bookings|selectattr('payment_status', 'equalto', 'Awaiting Verification')|list|length }}</h3>
            <p>Pending Payments</p>
        </div>
        <div class="stat-card">
            <h3>â‚¹{{ total_revenue }}</h3>
            <p>Total Revenue</p>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by name, email, or ticket ID...">
                </div>
                <div class="col-md-3">
                    <select id="statusFilter" class="form-control">
                        <option value="">All Status</option>
                        <option value="Paid">Paid</option>
                        <option value="Pending">Pending</option>
                        <option value="Awaiting Verification">Awaiting Verification</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <a href="/export_bookings" class="btn btn-success w-100">ðŸ“Š Export to Excel</a>
                </div>
                <div class="col-md-2">
                    <button id="refreshBtn" class="btn btn-primary w-100">ðŸ”„ Refresh</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bookings Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ðŸ“‹ Bookings Management</h5>
            {% if bookings|length == 0 %}
            <div class="alert alert-warning mb-0 py-2 px-3 small">
                No bookings yet. Ensure Google Sheet is configured (GOOGLE_SHEET_ID, creds.json or GOOGLE_CREDS_JSON) and shared with your service account email. <a href="{{ url_for('admin') }}">Refresh</a> to reload.
            </div>
            {% endif %}
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped" id="bookingsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Passes</th>
                            <th>Amount</th>
                            <th>Ticket ID</th>
                            <th>Payment Status</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in bookings %}
                        <tr data-status="{{ booking.payment_status }}">
                            <td>{{ booking.name }}</td>
                            <td>{{ booking.email }}</td>
                            <td>{{ booking.phone }}</td>
                            <td>{{ booking.passes }}</td>
                            <td>â‚¹{{ booking.amount|default(booking.passes * 200) }}</td>
                            <td><code>{{ booking.ticket_id }}</code></td>
                            <td>
                                <span class="badge bg-{{ 'success' if booking.payment_status == 'Paid' else 'warning' if booking.payment_status == 'Pending' else 'info' }}">
                                    {{ booking.payment_status }}
                                </span>
                            </td>
                            <td>
                                <select class="form-select form-select-sm status-select" data-ticket-id="{{ booking.ticket_id }}" data-original-value="{{ booking.payment_status }}">
                                    <option value="Pending" {{ 'selected' if booking.payment_status == 'Pending' else '' }}>Pending</option>
                                    <option value="Awaiting Verification" {{ 'selected' if booking.payment_status == 'Awaiting Verification' else '' }}>Awaiting Verification</option>
                                    <option value="Paid" {{ 'selected' if booking.payment_status == 'Paid' else '' }}>Paid</option>
                                </select>
                            </td>
                            <td>
                                <div class="d-flex flex-wrap gap-1">
                                    <button type="button" class="btn btn-outline-success btn-sm mail-btn" data-ticket-id="{{ booking.ticket_id }}" data-mail-type="success" title="Send success mail with ticket">ðŸ“§ Success</button>
                                    <button type="button" class="btn btn-outline-warning btn-sm mail-btn" data-ticket-id="{{ booking.ticket_id }}" data-mail-type="failure" title="Send failure mail">ðŸ“§ Failure</button>
                                    <button type="button" class="btn btn-outline-danger btn-sm delete-btn" data-ticket-id="{{ booking.ticket_id }}" title="Delete user">ðŸ—‘</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Search functionality
document.getElementById('searchInput').addEventListener('input', filterTable);
document.getElementById('statusFilter').addEventListener('change', filterTable);

function filterTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('#bookingsTable tbody tr');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const status = row.getAttribute('data-status');
        const matchesSearch = text.includes(searchTerm);
        const matchesStatus = !statusFilter || status === statusFilter;

        row.style.display = matchesSearch && matchesStatus ? '' : 'none';
    });
}

// Status update functionality
function attachStatusHandlers() {
    document.querySelectorAll('.status-select').forEach(select => {
        // Remove existing listeners by cloning
        const newSelect = select.cloneNode(true);
        select.parentNode.replaceChild(newSelect, select);
        
        newSelect.addEventListener('change', function() {
            const ticketId = this.getAttribute('data-ticket-id');
            const newStatus = this.value;
            const oldValue = this.getAttribute('data-original-value') || 'Pending';
            const row = this.closest('tr');

            // Disable select during update
            this.disabled = true;

            fetch('/update_booking_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    ticket_id: ticketId,
                    status: newStatus
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    row.setAttribute('data-status', newStatus);
                    this.setAttribute('data-original-value', newStatus);
                    const badge = row.querySelector('.badge');
                    badge.className = `badge bg-${newStatus === 'Paid' ? 'success' : newStatus === 'Awaiting Verification' ? 'info' : 'warning'}`;
                    badge.textContent = newStatus;
                    
                    // Update statistics without reload
                    updateStatistics();
                    
                    // Show success message if email was sent
                    if (data.message && data.message.includes('email sent')) {
                        alert('Status updated and ticket email sent!');
                    }
                } else {
                    alert('Error updating status: ' + (data.message || 'Unknown error'));
                    this.value = oldValue;
                }
                this.disabled = false;
            })
            .catch(error => {
                alert('Error updating status: Network error');
                console.error('Error:', error);
                this.value = oldValue;
                this.disabled = false;
            });
        });
    });
}

// Attach status handlers on page load
attachStatusHandlers();

// Refresh button
document.getElementById('refreshBtn').addEventListener('click', () => {
    location.reload();
});

// Delete booking
function attachDeleteHandlers() {
    document.querySelectorAll('.delete-btn').forEach(btn => {
        // Remove existing listeners by cloning
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', function() {
            const ticketId = this.getAttribute('data-ticket-id');
            const row = this.closest('tr');
            if (!confirm('Delete this booking? Sheet will be updated.')) return;
            
            const origText = this.textContent;
            this.disabled = true;
            this.textContent = 'Deleting...';
            
            fetch('/delete_booking', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ ticket_id: ticketId })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    row.remove();
                    updateStatistics(); // Update stats without reload
                } else {
                    alert('Delete failed: ' + (data.message || 'Unknown error'));
                    this.disabled = false;
                    this.textContent = origText;
                }
            })
            .catch(error => {
                alert('Delete failed: Network error');
                console.error('Error:', error);
                this.disabled = false;
                this.textContent = origText;
            });
        });
    });
}

// Update statistics dynamically
function updateStatistics() {
    const rows = document.querySelectorAll('#bookingsTable tbody tr');
    const totalBookings = rows.length;
    let paidCount = 0;
    let pendingCount = 0;
    let totalRevenue = 0;
    
    rows.forEach(row => {
        const status = row.getAttribute('data-status');
        if (status === 'Paid') {
            paidCount++;
            const amountText = row.querySelector('td:nth-child(5)').textContent.replace('â‚¹', '').trim();
            const amount = parseInt(amountText) || 0;
            totalRevenue += amount;
        } else if (status === 'Pending' || status === 'Awaiting Verification') {
            pendingCount++;
        }
    });
    
    // Update stat cards
    const statCards = document.querySelectorAll('.stat-card');
    if (statCards.length >= 4) {
        statCards[0].querySelector('h3').textContent = totalBookings;
        statCards[1].querySelector('h3').textContent = paidCount;
        statCards[2].querySelector('h3').textContent = pendingCount;
        statCards[3].querySelector('h3').textContent = 'â‚¹' + totalRevenue;
    }
}

// Attach delete handlers on page load
attachDeleteHandlers();

// Send mail (success/failure)
document.querySelectorAll('.mail-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const ticketId = this.getAttribute('data-ticket-id');
        const mailType = this.getAttribute('data-mail-type');
        const label = mailType === 'success' ? 'Success + Ticket' : 'Failure';
        if (!confirm(`Send ${label} mail to this user?`)) return;
        const orig = this.textContent;
        this.disabled = true;
        this.textContent = 'Sending...';
        fetch('/admin_send_mail', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ ticket_id: ticketId, mail_type: mailType })
        })
        .then(r => r.json())
        .then(data => {
            this.disabled = false;
            this.textContent = orig;
            alert(data.success ? 'Mail sent!' : (data.message || 'Failed to send.'));
        })
        .catch(() => { this.disabled = false; this.textContent = orig; });
    });
});
</script>
{% endblock %}
